/*! similo-js by Adam Timberlake <adam.timberlake@gmail.com> created on 2013-11-07 */
!function(a){"use strict";var b=require("node-phantom"),c=require("fs"),d=require("util"),e=require("crypto"),f=require("q"),g=require("moment"),h=require("ansi"),i=h(process.stdout),j=function(a){this._uri=a};j.prototype={_uri:null,_directory:null,_expiry:24,setDirectory:function(a){this._directory=a},throwError:function(a){a=d.format(" %s\n",a),i.hex("#553c45").bg.hex("#e7a3bd").write(" Similo: ").reset().write(" "+a+"\n"),this.reject(a)},setExpiry:function(a){this._expiry=a},fetch:function(a){var h=(new Date).getTime(),i=d.format("%s/%s",this._uri,a||""),j=e.createHash("sha1").update(i),k=j.digest("hex"),l=d.format("%s/%s.html",this._directory,k),m=f.defer(),n=f.defer(),o=this._expiry,p=this.throwError.bind(m),q=function(a){m.resolve({name:d.format("%s.html",k),cache:a,responseTime:(new Date).getTime()-h})};return o===!1?n.reject():c.stat(l,function(a,b){if(a)return n.reject(),void 0;var c=g((new Date).getTime()),d=g(b.ctime),e=d.diff(c,"hours");return e>o?(n.reject(),void 0):(n.resolve(),void 0)}),n.promise.then(function(){q(!0)}),n.promise.fail(function(){b.create(function(a,b){return a?p(a):b.createPage(function(a,d){return a?p(a):(d.open(i,function(a){return a?p(a):(d.evaluate(function(){return document.documentElement.innerHTML},function(a,d){return a?p(a):(c.writeFile(l,d,function(a){return a?p(a):(q(!1),b.exit(),void 0)}),void 0)}),void 0)}),void 0)})})}),m.promise}},a.exports=function(a){return new j(a)}}(module);