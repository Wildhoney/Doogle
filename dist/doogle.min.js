/*! doogle by Adam Timberlake <adam.timberlake@gmail.com> created on 2013-11-09 */
!function(a){"use strict";var b,c=require("node-phantom"),d=require("fs"),e=require("util"),f=require("crypto"),g=require("q"),h=require("moment"),i=require("ansi"),j=i(process.stdout),k=function(a){this._uri=a};k.prototype={_uri:null,_path:null,_file:null,_directory:null,_expiry:24,_timeStarted:0,_promises:{phantom:g.defer(),response:g.defer(),statistics:g.defer()},setDirectory:function(a){this._directory=a},throwError:function(a){a=e.format(" %s\n",a),j.hex("#553c45").bg.hex("#e7a3bd").write(" Doogle: ").reset().write(" "+a+"\n"),this.reject(a)},setExpiry:function(a){this._expiry=a},_sendResponse:function(a){b._promises.response.resolve({name:b._file,cache:!!a,responseTime:(new Date).getTime()-this._startTime})},fetch:function(a){var c=b._promises;c.phantom=g.defer(),c.response=g.defer(),c.statistics=g.defer(),b._startTime=(new Date).getTime();var d=b._path=e.format("%s/%s",this._uri,a||""),h=f.createHash("sha1").update(d),i=h.digest("hex");return b._file=e.format("%s.html",i),b._retrieveCache().then(function(){b._sendResponse(!0)}).fail(function(){b._bootstrapPhantom().then(function(){b._sendResponse(!1)}).fail(function(){b._promises.response.reject()})}),b._promises.response.promise},_retrieveCache:function(){var a=b._promises.statistics,c=e.format("%s/%s",b._directory,b._file);return d.stat(c,function(c,d){if(c)return a.reject(),void 0;var e=h((new Date).getTime()),f=h(d.ctime),g=f.diff(e,"hours");return g>b._expiry?(a.reject(),void 0):(a.resolve(),void 0)}),a.promise},_bootstrapPhantom:function(){var a=b._promises.phantom;return c.create(function(c,f){f.createPage(function(c,g){g.open(b._path,function(){g.evaluate(function(){return document.documentElement.innerHTML},function(c,g){var h=e.format("%s/%s",b._directory,b._file);d.writeFile(h,g,function(){a.resolve(),f.exit()})})})})}),a.promise}},a.exports=function(a){return b=new k(a)}}(module);